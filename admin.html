<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      body {
        font-family: system-ui, sans-serif;
        background: #f7f7f7;
        padding: 20px;
      }

      h1 {
        margin-bottom: 10px;
      }

      .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      input,
      button,
      select {
        padding: 8px;
        font-size: 14px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
      }

      th,
      td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        text-align: left;
      }

      th {
        background: #f0f0f0;
      }

      .status-checked {
        color: green;
        font-weight: bold;
      }

      .status-pending {
        color: orange;
        font-weight: bold;
      }

      .danger {
        background: #d9534f;
        color: white;
        border: none;
        cursor: pointer;
      }

      .success {
        background: #28a745;
        color: white;
        border: none;
        cursor: pointer;
      }

      .secondary {
        background: #555;
        color: white;
        border: none;
        cursor: pointer;
      }

      .badge {
        font-size: 12px;
        padding: 2px 6px;
        background: #eee;
        border-radius: 4px;
      }

      dialog {
        border: none;
        padding: 20px;
        width: 320px;
      }

      dialog form {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .stat-box {
        background: #fff;
        padding: 12px 16px;
        border-radius: 6px;
        min-width: 120px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }

      .stat-box strong {
        font-size: 22px;
        display: block;
      }
    </style>
  </head>
  <body>
    <h1>Admin Dashboard</h1>

    <div
      id="statsBar"
      style="display: flex; gap: 12px; margin: 15px 0; flex-wrap: wrap"
    >
      <div class="stat-box">
        <strong id="statTotal">0</strong>
        <div>Total Guests</div>
      </div>
      <div class="stat-box">
        <strong id="statChecked">0</strong>
        <div>Checked In</div>
      </div>
      <div class="stat-box">
        <strong id="statAwaiting">0</strong>
        <div>Awaiting</div>
      </div>
      <div class="stat-box">
        <strong id="statAdmin">0</strong>
        <div>Admin Added</div>
      </div>
    </div>

    <div class="controls">
      <input type="text" id="searchInput" placeholder="Search name..." />

      <select id="statusFilter">
        <option value="">All Status</option>
        <option value="awaiting">Awaiting</option>
        <option value="checked-in">Checked In</option>
      </select>

      <select id="adminFilter">
        <option value="">All Guests</option>
        <option value="admin">Admin Added</option>
      </select>

      <button id="addGuestBtn">Add Guest</button>
      <button id="exportBtn">Export CSV</button>
      <button id="logoutBtn">Logout</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Status</th>
          <th>Source</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="guestTableBody"></tbody>
    </table>

    <!-- ADD / EDIT MODAL -->
    <dialog id="guestModal">
      <form method="dialog" id="guestForm">
        <h3 id="modalTitle">Add Guest</h3>

        <input type="hidden" id="guestId" />

        <input
          type="text"
          id="fullNameInput"
          placeholder="Full Name"
          required
        />
        <input type="text" id="phoneInput" placeholder="Phone (optional)" />

        <div style="display: flex; gap: 10px">
          <button type="submit" class="success">Save</button>
          <button type="button" onclick="guestModal.close()">Cancel</button>
        </div>
      </form>
    </dialog>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDocs,
        query,
        orderBy,
        addDoc,
        updateDoc,
        doc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyARpD_soCNWZb5__AAtu6VJUicCy3yWrxU",
        authDomain: "muzzstorydb.firebaseapp.com",
        projectId: "muzzstorydb",
        storageBucket: "muzzstorydb.firebasestorage.app",
        messagingSenderId: "608283838734",
        appId: "1:608283838734:web:4a1e52a6c36a9b9ef6af5f",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const tableBody = document.getElementById("guestTableBody");
      const searchInput = document.getElementById("searchInput");
      const statusFilter = document.getElementById("statusFilter");
      const adminFilter = document.getElementById("adminFilter");
      const logoutBtn = document.getElementById("logoutBtn");
      const addGuestBtn = document.getElementById("addGuestBtn");
      const exportBtn = document.getElementById("exportBtn");

      const guestModal = document.getElementById("guestModal");
      const guestForm = document.getElementById("guestForm");
      const guestIdInput = document.getElementById("guestId");
      const fullNameInput = document.getElementById("fullNameInput");
      const phoneInput = document.getElementById("phoneInput");
      const modalTitle = document.getElementById("modalTitle");

      const statTotal = document.getElementById("statTotal");
      const statChecked = document.getElementById("statChecked");
      const statAwaiting = document.getElementById("statAwaiting");
      const statAdmin = document.getElementById("statAdmin");

      let rsvpData = [];
      let currentAdmin = null;

      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = "./404.html";
          return;
        }
        currentAdmin = user.email;
        init();
      });

      function init() {
        loadAllRsvps();
        searchInput.addEventListener("input", applyFilters);
        statusFilter.addEventListener("change", applyFilters);
        adminFilter.addEventListener("change", applyFilters);

        logoutBtn.onclick = async () => {
          await signOut(auth);
          window.location.href = "./admin-login.html";
        };

        addGuestBtn.onclick = () => {
          guestIdInput.value = "";
          fullNameInput.value = "";
          phoneInput.value = "";
          modalTitle.textContent = "Add Guest";
          guestModal.showModal();
        };

        exportBtn.onclick = exportCSV;
      }

      async function loadAllRsvps() {
        const q = query(collection(db, "rsvps"), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);

        rsvpData = snap.docs
          .map((d) => ({ id: d.id, ...d.data() }))
          .filter((g) => !g.deleted);

        renderTable(rsvpData);
        renderTable(rsvpData);
        updateStats(rsvpData);
      }

      function renderTable(data) {
        tableBody.innerHTML = "";

        if (!data.length) {
          tableBody.innerHTML = `<tr><td colspan="4">No guests</td></tr>`;
          return;
        }

        data.forEach((g) => {
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${g.fullName}</td>
            <td class="${
              g.status === "checked-in" ? "status-checked" : "status-pending"
            }">
              ${g.status === "checked-in" ? "Checked In" : "Awaiting"}
            </td>
            <td>
              ${g.adminAdded ? '<span class="badge">Admin</span>' : "RSVP"}
            </td>
            <td>
              ${
                g.status !== "checked-in"
                  ? `<button class="success" data-check="${g.id}">Check In</button>`
                  : ""
              }
              ${
                g.adminAdded
                  ? `<button class="secondary" data-edit="${g.id}">Edit</button>`
                  : ""
              }
              <button class="danger" data-del="${g.id}">Delete</button>
            </td>
          `;

          tableBody.appendChild(tr);
        });

        tableBody.onclick = handleTableActions;
      }

      function updateStats(data) {
        statTotal.textContent = data.length;
        statChecked.textContent = data.filter(
          (g) => g.status === "checked-in"
        ).length;
        statAwaiting.textContent = data.filter(
          (g) => g.status === "awaiting"
        ).length;
        statAdmin.textContent = data.filter((g) => g.adminAdded).length;
      }

      async function handleTableActions(e) {
        const id =
          e.target.dataset.check ||
          e.target.dataset.edit ||
          e.target.dataset.del;
        if (!id) return;

        const ref = doc(db, "rsvps", id);

        if (e.target.dataset.check) {
          await updateDoc(ref, {
            status: "checked-in",
            checkedInAt: serverTimestamp(),
            checkedInBy: currentAdmin,
          });
          loadAllRsvps();
        }

        if (e.target.dataset.edit) {
          const g = rsvpData.find((x) => x.id === id);
          guestIdInput.value = id;
          fullNameInput.value = g.fullName;
          phoneInput.value = g.phone || "";
          modalTitle.textContent = "Edit Guest";
          guestModal.showModal();
        }

        if (e.target.dataset.del) {
          if (!confirm("Soft delete this guest?")) return;
          await updateDoc(ref, { deleted: true });
          loadAllRsvps();
        }
      }

      guestForm.onsubmit = async (e) => {
        e.preventDefault();

        const payload = {
          fullName: fullNameInput.value.trim(),
          phone: phoneInput.value.trim(),
        };

        if (guestIdInput.value) {
          await updateDoc(doc(db, "rsvps", guestIdInput.value), payload);
        } else {
          await addDoc(collection(db, "rsvps"), {
            ...payload,
            status: "awaiting",
            adminAdded: true,
            createdAt: serverTimestamp(),
          });
        }

        guestModal.close();
        loadAllRsvps();
      };

      function applyFilters() {
        let data = [...rsvpData];

        const q = searchInput.value.toLowerCase();
        if (q) data = data.filter((g) => g.fullName.toLowerCase().includes(q));

        if (statusFilter.value)
          data = data.filter((g) => g.status === statusFilter.value);

        if (adminFilter.value === "admin")
          data = data.filter((g) => g.adminAdded);

        renderTable(data);
        renderTable(data);
        updateStats(data);
      }

      function exportCSV() {
        const rows = [["Full Name", "Status", "Source"]];
        rsvpData.forEach((g) =>
          rows.push([g.fullName, g.status, g.adminAdded ? "Admin" : "RSVP"])
        );

        const csv = rows.map((r) => r.join(",")).join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "guest-list.csv";
        a.click();
      }
    </script>
  </body>
</html>
