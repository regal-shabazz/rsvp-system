<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      body {
        font-family: system-ui, sans-serif;
        background: #f7f7f7;
        padding: 20px;
      }

      h1 {
        margin-bottom: 10px;
      }

      .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      input,
      button,
      select {
        padding: 8px;
        font-size: 14px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
      }

      th,
      td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        text-align: left;
      }

      th {
        background: #f0f0f0;
      }

      .status-checked {
        color: green;
        font-weight: bold;
      }

      .status-pending {
        color: orange;
        font-weight: bold;
      }

      .danger {
        background: #d9534f;
        color: white;
        border: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>Admin Dashboard</h1>

    <div class="controls">
      <input type="text" id="searchInput" placeholder="Search name..." />
      <select id="statusFilter">
        <option value="">All Status</option>
        <option value="pending">Pending</option>
        <option value="checked-in">Checked In</option>
      </select>
      <button id="logoutBtn">Logout</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Status</th>
          <th>Token</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="guestTableBody"></tbody>
    </table>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        getDocs,
        query,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyARpD_soCNWZb5__AAtu6VJUicCy3yWrxU",
        authDomain: "muzzstorydb.firebaseapp.com",
        projectId: "muzzstorydb",
        storageBucket: "muzzstorydb.firebasestorage.app",
        messagingSenderId: "608283838734",
        appId: "1:608283838734:web:4a1e52a6c36a9b9ef6af5f",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = "./404.html";
          return;
        }

        // user is authenticated
        initAdmin();
      });

      // ---------------------------
      // DATA SOURCE
      // ---------------------------
      //   const STORAGE_KEY = "rsvpData";
      //   let rsvpDataRaw = JSON.parse(localStorage.getItem(STORAGE_KEY));

      //   let rsvpData = Array.isArray(rsvpDataRaw)
      //     ? rsvpDataRaw
      //     : rsvpDataRaw
      //     ? [rsvpDataRaw]
      //     : [];

      // ---------------------------
      // ELEMENTS
      // ---------------------------
      const tableBody = document.getElementById("guestTableBody");
      const searchInput = document.getElementById("searchInput");
      const statusFilter = document.getElementById("statusFilter");
      const logoutBtn = document.getElementById("logoutBtn");
      let rsvpData = [];

      function initAdmin() {
        // renderTable(rsvpData);
        loadAllRsvps();

        searchInput.addEventListener("input", applyFilters);
        statusFilter.addEventListener("change", applyFilters);

        //   logoutBtn.addEventListener("click", () => {
        //     sessionStorage.removeItem("isAdmin");
        //     window.location.href = "./admin-login.html";
        //   });

        logoutBtn.addEventListener("click", async () => {
          await signOut(auth);
          window.location.href = "./admin-login.html";
        });
      }

      async function loadAllRsvps() {
        try {
          const q = query(
            collection(db, "rsvps"),
            orderBy("createdAt", "desc")
          );

          const snapshot = await getDocs(q);

          rsvpData = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          renderTable(rsvpData);
        } catch (err) {
          console.error("Failed to load RSVPs", err);
        }
      }

      // ---------------------------
      // RENDER TABLE
      // ---------------------------
      function renderTable(data) {
  tableBody.innerHTML = "";

  if (!Array.isArray(data) || data.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="4">No guests found</td></tr>`;
    return;
  }

  data.forEach((guest) => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${guest.fullName}</td>
      <td class="${
        guest.status === "checked-in"
          ? "status-checked"
          : "status-pending"
      }">
        ${guest.status === "checked-in" ? "Checked In" : "Awaiting"}
      </td>
      <td>${guest.token}</td>
      <td>
        <button class="danger" data-id="${guest.id}">Delete</button>
      </td>
    `;

    tableBody.appendChild(tr);
  });
}


      // ---------------------------
      // FILTER LOGIC
      // ---------------------------
      function applyFilters() {
  const searchValue = searchInput.value.toLowerCase();
  const statusValue = statusFilter.value;

  let filtered = rsvpData.filter(guest =>
    guest.fullName.toLowerCase().includes(searchValue)
  );

  if (statusValue === "checked-in") {
    filtered = filtered.filter(g => g.status === "checked-in");
  }

  if (statusValue === "awaiting") {
    filtered = filtered.filter(g => g.status === "awaiting");
  }

  renderTable(filtered);
}

    </script>
  </body>
</html>
